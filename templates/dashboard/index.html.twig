{% extends 'base.html.twig' %}

{% block title %}Tableau de bord - Budget Manager{% endblock %}

{% block page_title %}Tableau de bord{% endblock %}

{% block page_actions %}
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ path('app_dashboard', {'month': currentMonth - 1, 'year': currentYear}) }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-chevron-left"></i>
            </a>
            <button type="button" class="btn btn-sm btn-outline-secondary">
                {{ '%02d'|format(currentMonth) }}/{{ currentYear }}
            </button>
            <a href="{{ path('app_dashboard', {'month': currentMonth + 1, 'year': currentYear}) }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-chevron-right"></i>
            </a>
        </div>
        <a href="{{ path('app_transaction_new') }}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> Nouvelle transaction
        </a>
    </div>
{% endblock %}

{% block body %}
    <!-- Cartes de statistiques -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stat-card border-start border-success border-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Revenus</h6>
                        <h3 class="mb-0 text-success">{{ statistics.balance.income|number_format(2, ',', ' ') }} €</h3>
                    </div>
                    <div class="stat-icon bg-success bg-opacity-10 text-success">
                        <i class="bi bi-arrow-up-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card border-start border-danger border-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Dépenses</h6>
                        <h3 class="mb-0 text-danger">{{ statistics.balance.expense|number_format(2, ',', ' ') }} €</h3>
                    </div>
                    <div class="stat-icon bg-danger bg-opacity-10 text-danger">
                        <i class="bi bi-arrow-down-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card border-start border-primary border-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Solde</h6>
                        <h3 class="mb-0 {% if statistics.balance.balance >= 0 %}text-primary{% else %}text-danger{% endif %}">
                            {{ statistics.balance.balance|number_format(2, ',', ' ') }} €
                        </h3>
                    </div>
                    <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-wallet2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Graphique des dépenses par catégorie -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">Dépenses par catégorie</h5>
                    <canvas id="expensesChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Utilisation des budgets -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">Utilisation des budgets</h5>
                    {% if statistics.budgetUsage|length > 0 %}
                        {% for item in statistics.budgetUsage %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-medium">{{ item.budget.name }}</span>
                                    <span class="text-muted">{{ item.spent|number_format(2) }} / {{ item.budget.amount|number_format(2) }} €</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar {% if item.percentage > 100 %}bg-danger{% elseif item.percentage > 80 %}bg-warning{% else %}bg-success{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ item.percentage > 100 ? 100 : item.percentage }}%">
                                    </div>
                                </div>
                                <small class="text-muted">{{ item.percentage|number_format(1) }}% utilisé</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Aucun budget défini pour ce mois.</p>
                        <a href="{{ path('app_budget_new') }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-plus"></i> Créer un budget
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Évolution mensuelle -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">Évolution sur 12 mois</h5>
                    <canvas id="trendChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Dernières transactions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Dernières transactions</h5>
                        <a href="{{ path('app_transaction_index') }}" class="btn btn-sm btn-outline-primary">Voir tout</a>
                    </div>
                    {% if recentTransactions|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Titre</th>
                                        <th>Catégorie</th>
                                        <th>Type</th>
                                        <th class="text-end">Montant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in recentTransactions %}
                                        <tr>
                                            <td>{{ transaction.transactionDate|date('d/m/Y') }}</td>
                                            <td class="fw-medium">{{ transaction.title }}</td>
                                            <td>
                                                <span class="badge" style="background-color: {{ transaction.category.color }}">
                                                    {{ transaction.category.name }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if transaction.type == 'income' %}
                                                    <span class="badge bg-success">Revenu</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Dépense</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end fw-bold {% if transaction.type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                                {% if transaction.type == 'income' %}+{% else %}-{% endif %}{{ transaction.amount|number_format(2, ',', ' ') }} €
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">Aucune transaction enregistrée.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
<script>
    // Graphique des dépenses par catégorie
    const expensesData = {{ statistics.expensesByCategory|json_encode|raw }};
    if (expensesData.length > 0) {
        const ctx1 = document.getElementById('expensesChart').getContext('2d');
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: expensesData.map(e => e.categoryName),
                datasets: [{
                    data: expensesData.map(e => e.total),
                    backgroundColor: expensesData.map(e => e.color || '#6366f1'),
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    // Graphique d'évolution
    const trendData = {{ monthlyTrend|json_encode|raw }};
    if (trendData.length > 0) {
        const ctx2 = document.getElementById('trendChart').getContext('2d');
        new Chart(ctx2, {
            type: 'line',
            data: {
                labels: trendData.map(t => t.month),
                datasets: [
                    {
                        label: 'Revenus',
                        data: trendData.map(t => t.income),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Dépenses',
                        data: trendData.map(t => t.expense),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>
{% endblock %}
