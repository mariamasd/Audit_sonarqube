{% extends 'base.html.twig' %}

{% block title %}Rapport Mensuel - Budget Manager{% endblock %}

{% block page_title %}
    <i class="bi bi-file-earmark-bar-graph text-primary"></i> 
    Rapport Mensuel - {{ '%02d'|format(month) }}/{{ year }}
{% endblock %}

{% block page_actions %}
    <div class="btn-group">
        <a href="{{ path('app_dashboard_report', {'month': month - 1, 'year': year}) }}" 
           class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-chevron-left"></i> Mois précédent
        </a>
        <a href="{{ path('app_dashboard') }}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-house"></i> Tableau de bord
        </a>
        <a href="{{ path('app_dashboard_report', {'month': month + 1, 'year': year}) }}" 
           class="btn btn-sm btn-outline-secondary">
            Mois suivant <i class="bi bi-chevron-right"></i>
        </a>
    </div>
{% endblock %}

{% block body %}

    {# ===== RÉSUMÉ FINANCIER ===== #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-cash-stack"></i> Résumé Financier du Mois
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center g-4">
                        <div class="col-md-3">
                            <div class="p-3 bg-success bg-opacity-10 rounded">
                                <i class="bi bi-arrow-up-circle text-success" style="font-size: 2rem;"></i>
                                <h6 class="text-muted mt-2 mb-1">Total Revenus</h6>
                                <h2 class="text-success mb-0">
                                    {{ report.statistics.balance.income|number_format(2, ',', ' ') }} €
                                </h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-danger bg-opacity-10 rounded">
                                <i class="bi bi-arrow-down-circle text-danger" style="font-size: 2rem;"></i>
                                <h6 class="text-muted mt-2 mb-1">Total Dépenses</h6>
                                <h2 class="text-danger mb-0">
                                    {{ report.statistics.balance.expense|number_format(2, ',', ' ') }} €
                                </h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 {{ report.statistics.balance.balance >= 0 ? 'bg-primary' : 'bg-danger' }} bg-opacity-10 rounded">
                                <i class="bi bi-wallet2 {{ report.statistics.balance.balance >= 0 ? 'text-primary' : 'text-danger' }}" 
                                   style="font-size: 2rem;"></i>
                                <h6 class="text-muted mt-2 mb-1">Solde Net</h6>
                                <h2 class="{{ report.statistics.balance.balance >= 0 ? 'text-primary' : 'text-danger' }} mb-0">
                                    {{ report.statistics.balance.balance|number_format(2, ',', ' ') }} €
                                </h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-info bg-opacity-10 rounded">
                                <i class="bi bi-receipt text-info" style="font-size: 2rem;"></i>
                                <h6 class="text-muted mt-2 mb-1">Nombre de Transactions</h6>
                                <h2 class="text-info mb-0">{{ report.metrics.totalTransactions }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ===== MÉTRIQUES & PERFORMANCE ===== #}
    <div class="row mb-4">
        
        {# Métriques clés #}
        <div class="col-md-6 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up text-primary"></i> Métriques Clés
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted">
                                <i class="bi bi-calculator"></i> Dépense moyenne / transaction
                            </span>
                            <span class="badge bg-primary rounded-pill fs-6">
                                {{ report.metrics.averageExpense|number_format(2) }} €
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted">
                                <i class="bi bi-trophy"></i> Catégorie la + dépensée
                            </span>
                            <span class="fw-bold text-danger">
                                {{ report.metrics.topExpenseCategory ?? 'N/A' }}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted">
                                <i class="bi bi-cash"></i> Montant catégorie principale
                            </span>
                            <span class="badge bg-danger rounded-pill fs-6">
                                {{ report.metrics.topExpenseAmount|number_format(2) }} €
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted">
                                <i class="bi bi-percent"></i> Taux d'épargne
                            </span>
                            {% set savingsRate = report.statistics.balance.income > 0 
                                ? ((report.statistics.balance.balance / report.statistics.balance.income) * 100) 
                                : 0 %}
                            <span class="badge {{ savingsRate >= 0 ? 'bg-success' : 'bg-danger' }} rounded-pill fs-6">
                                {{ savingsRate|number_format(1) }}%
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        {# Performance budgétaire #}
        <div class="col-md-6 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart text-primary"></i> Performance Budgétaire
                    </h5>
                </div>
                <div class="card-body">
                    {% if report.statistics.budgetUsage|length > 0 %}
                        {% set totalBudget = 0 %}
                        {% set totalSpent = 0 %}
                        {% for item in report.statistics.budgetUsage %}
                            {% set totalBudget = totalBudget + item.budget.amount %}
                            {% set totalSpent = totalSpent + item.spent %}
                        {% endfor %}
                        
                        <div class="text-center mb-4">
                            <div class="position-relative d-inline-block">
                                <h1 class="display-4 mb-0 
                                    {{ (totalSpent / totalBudget * 100) > 100 ? 'text-danger' : 
                                       (totalSpent / totalBudget * 100) > 80 ? 'text-warning' : 'text-success' }}">
                                    {{ (totalSpent / totalBudget * 100)|number_format(1) }}%
                                </h1>
                            </div>
                            <p class="text-muted mb-1">Budget total utilisé</p>
                            <p class="mb-0">
                                <span class="text-danger fw-bold">{{ totalSpent|number_format(2) }} €</span>
                                <span class="text-muted"> / </span>
                                <span class="text-success fw-bold">{{ totalBudget|number_format(2) }} €</span>
                            </p>
                        </div>

                        <div class="progress mb-3" style="height: 25px;">
                            {% set budgetPercent = (totalSpent / totalBudget * 100) %}
                            <div class="progress-bar 
                                {{ budgetPercent > 100 ? 'bg-danger' : 
                                   budgetPercent > 80 ? 'bg-warning' : 'bg-success' }}"
                                 role="progressbar"
                                 style="width: {{ budgetPercent > 100 ? 100 : budgetPercent }}%">
                                {{ budgetPercent|number_format(1) }}%
                            </div>
                        </div>

                        {% if totalSpent > totalBudget %}
                            <div class="alert alert-danger mb-0">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Dépassement !</strong> 
                                Vous avez dépassé votre budget de 
                                <strong>{{ (totalSpent - totalBudget)|number_format(2) }} €</strong>
                            </div>
                        {% else %}
                            <div class="alert alert-success mb-0">
                                <i class="bi bi-check-circle"></i>
                                <strong>Bravo !</strong> 
                                Il vous reste 
                                <strong>{{ (totalBudget - totalSpent)|number_format(2) }} €</strong>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-pie-chart display-4"></i>
                            <p class="mt-3">Aucun budget défini pour ce mois</p>
                            <a href="{{ path('app_budget_new') }}" class="btn btn-outline-primary">
                                <i class="bi bi-plus"></i> Créer un budget
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# ===== RÉPARTITION DÉPENSES/REVENUS ===== #}
    <div class="row mb-4">
        
        {# Répartition des dépenses #}
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-arrow-down-circle"></i> Répartition des Dépenses
                    </h5>
                </div>
                <div class="card-body">
                    {% if report.statistics.expensesByCategory|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Catégorie</th>
                                        <th class="text-end">Montant</th>
                                        <th class="text-end">Part (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for expense in report.statistics.expensesByCategory %}
                                        <tr>
                                            <td>
                                                <span class="badge rounded-pill" 
                                                      style="background-color: {{ expense.color|default('#dc3545') }}">
                                                    {{ expense.categoryName ?? expense }}
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold">
                                                {{ expense.total|default(expense)|number_format(2) }} €
                                            </td>
                                            <td class="text-end">
                                                <span class="badge bg-danger bg-opacity-75">
                                                    {{ (expense.total|default(expense) / report.statistics.balance.expense * 100)|number_format(1) }}%
                                                </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td>TOTAL</td>
                                        <td class="text-end text-danger">
                                            {{ report.statistics.balance.expense|number_format(2) }} €
                                        </td>
                                        <td class="text-end">100%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">Aucune dépense ce mois-ci</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Répartition des revenus #}
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-arrow-up-circle"></i> Répartition des Revenus
                    </h5>
                </div>
                <div class="card-body">
                    {% if report.statistics.incomesByCategory|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Catégorie</th>
                                        <th class="text-end">Montant</th>
                                        <th class="text-end">Part (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for income in report.statistics.incomesByCategory %}
                                        <tr>
                                            <td>
                                                <span class="badge rounded-pill" 
                                                      style="background-color: {{ income.color|default('#198754') }}">
                                                    {{ income.categoryName ?? income }}
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold">
                                                {{ income.total|default(income)|number_format(2) }} €
                                            </td>
                                            <td class="text-end">
                                                <span class="badge bg-success bg-opacity-75">
                                                    {{ (income.total|default(income) / report.statistics.balance.income * 100)|number_format(1) }}%
                                                </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td>TOTAL</td>
                                        <td class="text-end text-success">
                                            {{ report.statistics.balance.income|number_format(2) }} €
                                        </td>
                                        <td class="text-end">100%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">Aucun revenu ce mois-ci</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# ===== LISTE COMPLÈTE DES TRANSACTIONS ===== #}
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul text-primary"></i> 
                        Toutes les Transactions 
                        <span class="badge bg-secondary">{{ report.transactions|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if report.transactions|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th><i class="bi bi-calendar"></i> Date</th>
                                        <th><i class="bi bi-card-text"></i> Titre</th>
                                        <th><i class="bi bi-tag"></i> Catégorie</th>
                                        <th><i class="bi bi-arrow-left-right"></i> Type</th>
                                        <th><i class="bi bi-credit-card"></i> Paiement</th>
                                        <th class="text-end"><i class="bi bi-cash"></i> Montant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in report.transactions %}
                                        <tr>
                                            <td class="text-nowrap">
                                                <small class="text-muted">
                                                    {{ transaction.transactionDate|date('d/m/Y') }}
                                                </small>
                                            </td>
                                            <td class="fw-medium">{{ transaction.title }}</td>
                                            <td>
                                                <span class="badge rounded-pill" 
                                                      style="background-color: {{ transaction.category.color|default('#6c757d') }}">
                                                    {{ transaction.category.name }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if transaction.type == 'income' %}
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-arrow-up"></i> Revenu
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-danger">
                                                        <i class="bi bi-arrow-down"></i> Dépense
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    {{ transaction.paymentMethod|default('-') }}
                                                </small>
                                            </td>
                                            <td class="text-end fw-bold {{ transaction.type == 'income' ? 'text-success' : 'text-danger' }}">
                                                {{ transaction.type == 'income' ? '+' : '-' }}{{ transaction.amount|number_format(2, ',', ' ') }} €
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-inbox display-1"></i>
                            <h4 class="mt-3">Aucune transaction pour ce mois</h4>
                            <p>Commencez par ajouter vos premières transactions</p>
                            <a href="{{ path('app_transaction_new') }}" class="btn btn-primary mt-2">
                                <i class="bi bi-plus-circle"></i> Ajouter une transaction
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

{% endblock %}
